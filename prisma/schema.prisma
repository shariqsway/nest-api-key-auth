generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model ApiKey {
  id               String   @id @default(cuid())
  name             String
  keyPrefix        String
  hashedKey        String
  scopes           String[] @default([])
  expiresAt        DateTime?
  revokedAt        DateTime?
  lastUsedAt       DateTime?
  ipWhitelist      String[] @default([])
  rateLimitMax     Int?
  rateLimitWindowMs Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  auditLogs        AuditLog[]

  @@unique([keyPrefix, hashedKey])
  @@index([keyPrefix])
  @@index([expiresAt])
  @@map("api_keys")
}

model AuditLog {
  id          String   @id @default(cuid())
  keyId       String
  keyName     String?
  ipAddress   String
  method      String
  path        String
  statusCode  Int?
  success     Boolean
  errorMessage String? @db.Text
  requestId   String?
  timestamp   DateTime @default(now())

  apiKey      ApiKey?  @relation(fields: [keyId], references: [id], onDelete: Cascade)

  @@index([keyId])
  @@index([timestamp])
  @@index([success])
  @@index([ipAddress])
  @@map("audit_logs")
}

